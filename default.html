<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>Filet Cloud</title>
<style>
	body {margin: 0px; display: flex; flex-direction: row; height: 100vh;}
	div {word-break: break-all;}
	#data,#index {width: 50%; height: 100%;}
	#index {display: flex; flex-direction: column;}
	#menu {display: flex; flex-direction: row; font-size: 1.6vw;}
	#dir,#data {overflow-y: auto; }
	#data * {
		display: block; object-fit: contain;
		margin: auto; width: 100%; max-height: 100%;}
	h1,h2 {
		font-weight: normal; cursor: default;
		margin: 0px; margin-left: 0.1rem; margin-right: 0.1rem;}
	@media (hover: none) {body {font-size: 1.5em;}}
	@media (orientation: portrait) {
		@media (hover: none) {body {font-size: 3em;}}
		body {flex-direction: column-reverse;}
		#menu {font-size: 3.2vw;}
		#data,#index {width: 100%; height: 50%;}}
</style>
</head>
<body>
<div id=index>
	<h1>&#9925 Filet Cloud</h1>
	<div id=menu>
		<h1 onclick="nav(cwdParent(), 1)">&#128281</h1>
		<h1 onclick="makedir()">&#128193</h1>
		<h1 onclick="uploadEl.click()">&#128228</h1>
		<h1 onclick="rename()">&#128394</h1>
		<h1 onclick="tabopen()">&#128214</h1>
		<h1 onclick="download()">&#128229</h1>
		<h1 onclick="move()">&#128666</h1>
		<h1 onclick="del()">&#128465</h1>
		<h1 onclick="cartSel()" id="cart">&#128722</h1>
		<div id=cartlen>0</div>
	</div>
	<div id=path></div>
	<div id=dir></div>
</div>
<div id=data></div>
<input id="upload" type="file" multiple onchange="send()" style="display:none"/>
<script>
	var cart = []
	let curPath = ()=>document.getElementById('path').innerText
	let cwd = ()=>curPath().replace(/[^/]+$/g, '')
	let cwdParent = ()=>cwd().replace(/[^/]+\/$/g, '')
	let dataEl = document.getElementById('data')
	let sel = document.getElementById('cart').style

	// Basic error handler for queries to the server.
	let check = okayFn=> async r=> {
		if (r.ok) r.json().then(j=> okayFn(j)).catch(e=> okayFn(null))
		else dataEl.replaceChildren(document.createTextNode(await r.text())) }

	/**
	 * Switches between cart and normal selection modes.
	 * If the current path is a file, it will just add the,
	 * file to the cart or switch to the cart, if the file is
	 * already in the cart.
	 */
	function cartSel() {
		sel.filter = sel.filter ? '' : 'drop-shadow(0.2rem 0.2rem 0.2rem indigo)'
		if (sel.filter && !curPath().endsWith('/') && !cart.includes(curPath())) {
			// If a file is selected, add to the cart without switching to cart mode.
			nav(curPath())
			sel.filter = ''
		}
		nav(curPath(), 1)
	}

	/**
	 * Navigate to and show a file or directory, or,
	 * if cart selection mode is active, show the cart and add and
	 * remove from it instead of navigating.
	 * For folders, path should be terminated in a "/"
	 * Sets the current files or directories for future actions.
	 * Updates the folder area with interactive tree navigation.
	 * Displays file contents as best it can.
	 * 
	 * @param {bool} forceNav Ignore cart selection mode in navigating
	 * @param {bool} refresh Force redraw the working dir contents
	 */
	function nav(path, forceNav, refresh) {
		// Function to generate directory entry selector elements.
		dirSel = (isFile, name, path)=> {
			nib = document.createElement("h2")
			nib.onclick = ()=>nav(path)
			nib.innerText = `${isFile?'\u{1F4C4}':'\u{1F4C2}'} ${name}`
			return nib}

		// Handle addition and removal from cart if in cart selection mode
		if (sel.filter && !forceNav) {
			index = cart.indexOf(path)
			index < 0 ? cart.push(path) : cart.splice(index, 1)
			document.getElementById('cartlen').innerText = cart.length.toString()
		}
		// Show the cart entries, if it's selected
		dataEl.replaceChildren(...
			sel.filter ? cart.map(c=> dirSel(!c.endsWith('/'), c, c)) : [])

		// Handle directory navigation, or file content display
		if ((refresh || path.endsWith("/")) && (!sel.filter || forceNav)) {
			dir = path.replace(/[^/]+$/g, '')
			// Query the contents of the directory
			fetch(`dir?path=${encodeURIComponent(dir)}`)
			.then(check(r=> { r.sort()
				// Update the location to this directory if we aren't just refreshing
				if (path.endsWith("/"))
					document.getElementById('path').innerText = path
				document.getElementById('dir').replaceChildren(...r.map(([f, n])=>
					dirSel(f, n, dir + n + (f?"":"/"))))}))
		}
		if (!path.endsWith("/") && !sel.filter) {
			// Display file contents as best it can
			document.getElementById('path').innerText = path
			/* Attempts to load the selected file on a given html element.
				Intended for "img" and "video" */
			function tryElement(element, fallback) {
				doc = document.createElement(element)
				doc.controls = "controls"
				doc.onload = doc.oncanplay = ()=>dataEl.replaceChildren(doc)
				doc.onerror = fallback
				doc.src = `/file?path=${encodeURIComponent(path)}`
			}
			// Hit the fallback approach attempting to load the content.
			tryElement("img", ()=>tryElement("video", ()=>
				dataEl.innerText = "Unknown format: " + path))
		}
	}

	/**
	 * Make a directory on the server.
	 * The user is prompted for the name of the new directory and
	 * it is made inside the current directory.
	 */
	function makedir() {
		if (!(newDir = prompt("New Folder:", ""))) return
		fetch(`newdir?path=${encodeURIComponent(cwd() + newDir)}`)
		.then(check(r=> nav(cwd())))
	}

	/**
	 * Rename a file or directory on the server.
	 * The user is prompted for the new name.
	 */
	 function rename() {
		folder = curPath().replace(/[^/]+\/?$/g, '')
		oldName = curPath().replace(/\/?$/g, '').split('/').pop()
		if (!(newName = prompt("Rename:", oldName)) || newName == oldName) return


		console.log(folder + newName + curPath().endsWith('/')?'/':'')

		fetch(`rename?path=${encodeURIComponent(folder + oldName)}&` +
			`to=${encodeURIComponent(folder + newName)}`)
		.then(check(r=> nav(folder + newName + (folder==cwd()?'':'/'), 0, 1)))
	}

	/**
	 * Start uploading of files to the server.
	 * Files are uploaded into the current directory.
	 * This is called after the file selection popup has been loaded
	 * and files have been selected.
	 */
	function send() {
		uploadEl = document.getElementById('upload')
		uploadForm = new FormData()
		for (i = 0; i < uploadEl.files.length; i++)
			uploadForm.append("files[]", uploadEl.files[i])
		fetch(`upload?path=${encodeURIComponent(cwd())}`,
			{method: 'POST', body: uploadForm})
		.then(check(r=> nav(cwd())))
	}

	function tabopen() { // TODO docs
		// TODO expand to use "open" page.
		if (curPath() == cwd()) return // ignore folders
		window.open(`/file?path=${encodeURIComponent(curPath())}`, "_blank")
	}

	// Trigger the load of the page.
	window.onload = ()=>nav({{.P}})
</script>
</body>
</html>
